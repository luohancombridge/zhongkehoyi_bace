{% extends "/hualala/pages/base.html" %}
{% block content %}
    <style type="text/css">
        .mt-10 {
            margin-top: 25px;
        }
        .mt-low {
            margin-top: 15px;
        }
.textarea{
    width: 650px;
    min-height: 220px;
    max-height: 300px;
    _height: 120px;
    margin-left: auto;
    margin-right: auto;
    padding: 3px;
    outline: 0;
    border: 1px solid #a0b3d6;
    font-size: 12px;
    line-height: 24px;
    padding: 2px;
    word-wrap: break-word;
    overflow-x: hidden;
    overflow-y: auto;
    border-color: rgba(82, 168, 236, 0.8);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);
}
        .row.no-gutter {
            margin-left: 0;
            margin-right: 0;
        }
    </style>
<div class="container-fluid">
    <div class="row mt-10">
        <div class="col-md-7">
            <div class="panel panel-default"   id="first_panel">
                <div class="panel-heading">
                   项目列表
                </div>
                <div class="panel-body">
                    <div class="row ">
                        <div class="col-sm-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-addon  input-group-xs" id="basic-addon1"  run_type="no">输入case目录</span>
                                <input type="text" class="form-control" placeholder="Username"
                                       aria-describedby="basic-addon1"  id="mulu_detail">
                                <span class="input-group-btn">
                                    <button class="btn btn-info" type="button"  id="case_sousuo"   port={{ port }}>搜索</button>
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group  form-group-sm  ">
                                <div class="btn-group" role="group" aria-label="...">
                                    <button type="button" class="btn btn-info btn-sm" id="all_case_run"  >&#8194运行&#8194</button>
                                    <button type="button" class="btn btn-success btn-sm" id="read_result">查看结果</button>
                                    <button type="button" class="btn btn-danger btn-sm" id="yincang_all">隐藏方法</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row  ">
                        <div class="col-md-12 "  style=" height:500px; overflow:auto;">
                            <div class="panel panel-success">
                                <div class="panel-body">
                                    <table class="table table-hover  table-condensed  ">
                                        <thead>
                                        <tr  >
                                            <th>
                                                <input type="checkbox"  name="all_choice">
                                                选择</th>
                                            <th>类名</th>
                                            <th>类描述</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody  id="xiangmu_body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5 ">
            <div class="panel panel-success" >
                <div class="panel-heading">运行详情</div>
                <div class="panel-body">
                <div class="container-fluid ">
                    <div class="row">
                        <div class="int-group input-group-sm">
                        <div class="col-xs-7">
                            <form class="form-horizontal">
  <div class="form-group">
                            <h6  id="long_all_num">
                                <span class="label label-success">成功</span>&nbsp
                               0&nbsp&nbsp<span class="label label-danger">失败</span>&nbsp0
                                &nbsp&nbsp<span class="label label-warning">出错</span>&nbsp0&nbsp&nbsp</h6>
         </div>
                            </form>
                        </div>
                        <div class="col-xs-5"  id="progress">
                            <div class="progress progress-striped active"  style="position: relative; top: 10px; left: -20px; z-index: 2;">
                                <div class="progress-bar progress-bar-success " role="progressbar" aria-valuenow="60"
                                  id="jindu"   aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                    <span >0% 完成</span>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    <div class="row  mt-10  "   id="log_scroll" style=" height:550px; overflow:auto; ">
                        <div class="col-md-12 " >
                        <pre   id="run_detail_add"   style = "border:none; overflow:hidden;background:none" >
                        </pre>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>










<table class="table table-hover  table-condensed  "  id="class_yincang">
    <tbody  id="class_table">
    <tr tr_type="class">
        <td   >
            <input type="checkbox"  name="cl_choice">
        </td>
        <td  name="class_name">afaeefef</td>
        <td name="class_doc">affef</td>
        <td>
            <div class="btn-toolbar" role="toolbar" aria-label="...">
                <div class="btn-group" role="group">
                    <div class="btn-group" role="group" aria-label="...">
                        <button type="button" class="btn btn-info btn-xs" id="class_run_case_all"  name="case_run">&#8194运行&#8194</button>
                        <button type="button" class="btn btn-success btn-xs"   name="class_simple_result">查看结果</button>
                        <button type="button" class="btn btn-warning  btn-xs" name="fangfa_list_shwo">方法列表</button>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<table class="table     "  id="fangfa_head">
    <tbody  id="fangfa_head_hide">
    <tr class="info" tr_type="def"  table_type="def_head">
        <td   >
           选择
        </td>
        <td  name="class_name">方法名</td>
        <td name="class_doc">方法描述</td>
        <td>
           操作
        </td>
    </tr>
    </tbody>
</table>

<table class="table   "  id="fangfa_yincang">
    <tbody  id="fangfa_table">
    <tr  class="info"   tr_type="def">
        <td   >
            <input type="checkbox"  name="def_choice">
        </td>
        <td  name="def_name">afaeefef</td>
        <td name="def_doc">affef</td>
        <td>
            <div class="btn-toolbar" role="toolbar" aria-label="...">
                <div class="btn-group" role="group">
                    <div class="btn-group" role="group" aria-label="...">
                        <button type="button" class="btn btn-info  btn-xs"  id="def_run"  name="def_run">&#8194运行&#8194</button>
                        <button type="button" class="btn btn-success btn-xs"  name="def_result">查看结果</button>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    </tbody>
</table>
    <script src="static/hualala/vendor/jquery/jquery.min.js"></script>
    <script src="static/hualala/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="static/hualala/vendor/metisMenu/metisMenu.min.js"></script>
    <script src="static/hualala/dist/js/sb-admin-2.js"></script>
    <script src="{{ url_for('static', filename='layer-v3.0/layer/layer.js') }}">
    <script src = "{{url_for('static', filename='jquery-1.8.0.js')}}" ></script>
 <script src="{{url_for('static', filename='test_file/test5.js')}}"></script>
    <script type=text/javascript>
    $(document).ready(function()
    {
        $('#run_detail_add').html('<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>')

    })
    //轮流查询接口返回状态
    function   lun_run_type()
    {
        //获取最新的job运行状态
        var port=$('#case_sousuo').attr('port')
        $.post('http://127.0.0.1:'+port+'/run_log',{statu:'run_log'},
        function(data)
        {
           $('#run_detail_add').html($('#run_detail_add').html()+data.return_desc)
            $('#long_all_num').attr('success_num',data.success_num)
            $('#long_all_num').attr('fail_num',data.fail_num)
            $('#long_all_num').attr('fail_num',data.error_num)
            var all_case_num=parseInt(data.fail_num)+parseInt(data.success_num)+parseInt(data.error_num)
                $('#long_all_num').html('<span class="label label-success">成功</span>&nbsp'+data.success_num+'&nbsp&nbsp<span class="label label-danger">失败</span>&nbsp' +
                    data.fail_num+'&nbsp&nbsp<span class="label label-warning">出错</span>&nbsp'+data.error_num+'&nbsp&nbsp</h6>')

            if (parseInt(data.fail_num)!=0)
            {
                $('#jindu').attr('class','progress-bar progress-bar-danger ')
            }
            else if(parseInt(data.error_num)!=0)
            {
                $('#jindu').attr('class','progress-bar progress-bar-warning')
            }
            else
            {
                $('#jindu').attr('class','progress-bar progress-bar-success')
            }
             var kk='------------------------------------------------------------------------------<br>Ran'
            if (parseInt($('#jindu').attr('case_num'))<=all_case_num   &&  $('#run_detail_add').html().indexOf(kk)<0) {
                if (data.fail_num!= 0 || data.error_num != 0) {
                   var  statu_end = 'FAILED (failures=' + String(data.fail_num) + ',errors=' + String(data.error_num) + ')'

                } else {
                  var   statu_end = 'SUCCES'
                }
                var s = '------------------------------------------------------------------------------<br>' +
                    'Ran ' + $('#jindu').attr('case_num') + ' tests in 20.010s<br><br>' + statu_end
                $('#run_detail_add').html($('#run_detail_add').html() + '<br>' + s)
            }
            $('#log_scroll').scrollTop(50000000)
            var case_num=parseInt($('#jindu').attr('case_num'))
            style="width: 0%;"
            wanchengdu=String(parseInt(String(all_case_num/case_num*100)))+'%'
            $('#jindu').attr('style','width:'+wanchengdu+";")
            $('#jindu').find('span').html(wanchengdu+'完成')


        })
        var port=$('#case_sousuo').attr('port')
        $.post('http://127.0.0.1:'+port+'/run_statu_ui',{run:"22"},
        function(data)
        {
            if(data.data.length>0)
            {
                $.each(data.data,function(a,b)
                {

                  if (b[0]=="class_run_case_all")
                  {
                      var  class_name=b[1]
                      var button_class=$('tr[class_name="'+class_name +'"]').find('#class_run_case_all')
                      if  (button_class.html()=="运行中" && b[2]=="done")
                      {
                          button_class.html('&#8194运行&#8194')
                          button_class.attr('disabled',false)
                          button_class.next().attr('disabled',false)
                      }
                  }
                    else if (b[0]=="def_run")
                    {
                        var  class_name=b[1].split('$')[1]
                        var def_name=b[1].split('$')[0]
                        var button_class=$('button[cl_name="'+class_name +'"][def_name="'+def_name+'"]')
                        if  (button_class.html()=="运行中" && b[2]=="done")
                        {
                            button_class.html('&#8194运行&#8194')
                            button_class.attr('disabled',false)
                            button_class.next().attr('disabled',false)
                        }
                    }
                  else if (b[0]=="run_all")
                  {
                      var  all_run_button=$('#all_case_run')
                      if  (all_run_button.html()=="运行中" && b[2]=="done")
                      {
                          all_run_button.html('&#8194运行&#8194')
                          all_run_button.attr('disabled',false)
                          all_run_button.next().attr('disabled',false)
                      }
                  }
                })
            }
            else {
                clearInterval(c)
                $('#run_detail_add').attr('style','border:none;background:none')
                $('#log_scroll').scrollTop(50000000)
                $('#basic-addon1').attr('run_type','no')
                var  all_run_button=$('#all_case_run')
                all_run_button.attr('disabled',false)
                all_run_button.next().attr('disabled',false)
                all_run_button.html('&#8194运行&#8194')
                $('button[name="case_run"]').each(function()
                {
                    $(this).html('&#8194运行&#8194')
                    $(this).attr('disabled',false)
                    $(this).next().attr('disabled',false)
                }
                )
                $('button[name="def_run"]').each(function()
                    {
                        $(this).html('&#8194运行&#8194')
                        $(this).attr('disabled',false)
                        $(this).next().attr('disabled',false)
                    }
                )
            }
        }
            )
    }
    //全部运行
        $('#all_case_run').click(function()
    {
        $('#long_all_num').html('<span class="label label-success">成功</span>&nbsp0'+'&nbsp&nbsp<span class="label label-danger">失败</span>&nbsp' +
          '0'+'&nbsp&nbsp<span class="label label-warning">出错</span>&nbsp0'+'&nbsp&nbsp</h6>')
        $('#jindu').attr('case_num',0)
        wanchengdu='0%'
        $('#jindu').attr('style','width:'+wanchengdu+";")
        $('#jindu').find('span').html(wanchengdu+'完成')
        var case_num=0
        $('#run_detail_add').html('')
        $('#all_case_run').html('运行中')
        $('#all_case_run').attr('disabled',true)
        $('#read_result').attr('disabled',true)
        var class_list = new Array()
        var def_list = new Array()
        $('[type="checkbox"][name="cl_choice"]').each(function(){
            if ($(this).is(':checked'))
            {

              var class_name=$(this).parent().parent().attr('class_name')
                // case_num=$('[class_name="'+'test_nexe.aadsddd'+'"]').length-2+case_num
                class_list.push(class_name)
            }
        })
        $('[type="checkbox"][name="def_choice"]').each(function(){
            var class_name=$(this).parent().parent().attr('class_name')
            if ($.inArray(class_name, class_list)>=0 && class_name!=undefined)
            {
                case_num=case_num+1
            }
            else if ($(this).is(':checked'))
            {
                var def_name=$(this).parent().parent().find('td').eq(1).html()
                def_list.push(def_name+"&"+class_name)
                    case_num=case_num+1


            }
        })
        mulu=$('#mulu_detail').attr('mulu')
        $('#jindu').attr('case_num',case_num)
        $('#run_detail_add').attr('style','border:none; overflow:hidden;background:none')
        var port=$('#case_sousuo').attr('port')
        $.post('http://127.0.0.1:'+port+'/run_simple',{mulu:mulu,type:'run_all',class_list:JSON.stringify(class_list),def_list:JSON.stringify(def_list)},
        function(data)
        {

            if (data.statu=='chongfu')
            {
                $('#all_case_run').html('&#8194运行&#8194')
                $('#all_case_run').attr('disabled',false)
                $('#read_result').attr('disabled',false)
                layer.msg('在运行中，请稍后再试',{icon: 2})
            }
            if (data.statu=='success')
            {
                if ($('#basic-addon1').attr('run_type')=='no')
                {
                    $('#basic-addon1').attr('run_type','yes')
                    c=setInterval("lun_run_type()",1000)
                }
            }
            else
            {
                $('#all_case_run').html('&#8194运行&#8194')
                $('#all_case_run').attr('disabled',false)
                $('#read_result').attr('disabled',false)
            }
        })
    })
    //case运行
    $('#first_panel').on('click','[name="case_run"]',function()
        {
            var class_name=$(this).parent().parent().parent().parent().parent().attr("class_name")
            $('#jindu').attr('case_num',0)
            $('#long_all_num').html('<span class="label label-success">成功</span>&nbsp0'+'&nbsp&nbsp<span class="label label-danger">失败</span>&nbsp' +
                '0'+'&nbsp&nbsp<span class="label label-warning">出错</span>&nbsp0'+'&nbsp&nbsp</h6>')
            wanchengdu='0%'
            $('#jindu').attr('style','width:'+wanchengdu+";")
            $('#jindu').find('span').html(wanchengdu+'完成')
            $('#jindu').attr('case_num',0)
            $('#run_detail_add').html('')
            $(this).html('运行中')
            $(this).next('button').attr('disabled',true)
            $(this).attr('disabled',true)
            var type_id=$(this).attr('id')
            if (type_id="class_run_case_all")
            {
            class_name=$(this).parent().parent().parent().parent().parent().attr("class_name")
            {#mulu="C:\\jieyuelianhe\\old_all_server\\ui_test\\case_list\\dic_test"#}
                mulu=$('#case_sousuo').attr('name')
        }
        //case  数量
            case_num=$('[class_name="'+class_name+'"]').length-2
            $('#jindu').attr('case_num',case_num)
            $('#run_detail_add').attr('style','border:none; overflow:hidden;background:none')
            var port=$('#case_sousuo').attr('port')
$.post('http://127.0.0.1:'+port+'/run_simple',{type:type_id,class_name:class_name,mulu:mulu},
function(){
    if ($('#basic-addon1').attr('run_type')=='no')
    {
        $('#basic-addon1').attr('run_type','yes')
        c=setInterval("lun_run_type()",1000)
    }
})
        }
    )
    //def运行
    $('#first_panel').on('click','[name="def_run"]',function()
        {
            $('#jindu').attr('case_num',0)
            $('#long_all_num').html('<span class="label label-success">成功</span>&nbsp0'+'&nbsp&nbsp<span class="label label-danger">失败</span>&nbsp' +
                '0'+'&nbsp&nbsp<span class="label label-warning">出错</span>&nbsp0'+'&nbsp&nbsp</h6>')
            wanchengdu='0%'
            $('#jindu').attr('style','width:'+wanchengdu+";")
            $('#jindu').find('span').html(wanchengdu+'完成')
            $('#jindu').attr('case_num',1)
            $('#run_detail_add').html('')
            $(this).html('运行中')
            $(this).next('button').attr('disabled',true)
            $(this).attr('disabled',true)
            var type_id=$(this).attr('name')
            var class_name=$(this).attr('cl_name')
            var def_name=$(this).attr('def_name')
            mulu="C:\\jieyuelianhe\\old_all_server\\ui_test\\case_list\\dic_test"
            $('#run_detail_add').attr('style','border:none; overflow:hidden;background:none')
            var port=$('#case_sousuo').attr('port')
            $.post('http://127.0.0.1:'+port+'/run_simple',{type:type_id,class_name:class_name,mulu:mulu,def_name:def_name},
                function(){
                    if ($('#basic-addon1').attr('run_type')=='no')
                    {
                        $('#basic-addon1').attr('run_type','yes')
                        c=setInterval("lun_run_type()",1000)
                    }
                })
        }
    )
    //全部隐藏
    $('#yincang_all').click(function()
    {
$('[tr_type="def"]').hide()
    })
//class  case 全选
$('[name="all_choice"]').click(function()
    {
      if ($('[name="all_choice"]').is(':checked'))
      {
          $('[name="def_choice"]').prop('checked',false)
       $('[name="cl_choice"]').prop('checked',true)
      }
      else
      {
          $('[name="def_choice"]').prop('checked',false)
          $('[name="cl_choice"]').prop('checked',false)
      }
    }
)
$('#xiangmu_body').on('click','[name="cl_choice"]',function()
    {
        var class_name=$(this).parent().parent().attr('class_name')
        if ($(this).is(":checked"))
        {
            $('[name="def_choice"][cl_name="'+class_name+'"]').each(function()
            {
                if ($(this).is(":visible"))
                {
                   $(this).prop('checked',true)
                }
            })
        }
        else
        {
            $('[name="def_choice"]').prop('checked',false)
        }
    }
)

//点击方法list按钮，显示clas下方法列表
$('#xiangmu_body').on('click','[name="fangfa_list_shwo"]',function()
    {
        var class_name=$(this).attr('cl_name')
        if ( $('[class_name="'+class_name+'"]').eq(-1).is(':visible'))
        {
            $('[class_name="'+class_name+'"]').hide()
            $('[class_name="'+class_name+'"]').eq(0).show()
        }
        else {
            $('[class_name="'+class_name+'"]').show()
        }
    }
)
    $(document).ready(

function()
{

    $('#fangfa_head_hide').hide()
    $('#class_yincang').hide()
    $('#fangfa_table').hide()
   // var fangfa_head=$('#fangfa_head_hide').html()
   //  var fangfa_html=$('#fangfa_table').html()
   //  var htmle_table=$('#class_table').html()
   //  $('#xiangmu_body').append(htmle_table)
   //  $('#xiangmu_body').append(fangfa_head)
   //  $('#xiangmu_body').append(fangfa_html)
    $('xiangmu_body').find('tr').each(function()
        {
            $(this).show()
        }
    )
}
    )
    //搜索case
    $('#case_sousuo').click(function()
    {
        $('#run_detail_add').html()
        $(this).attr('disabled',true)
        $('#xiangmu_body').empty()
        var mulu=$.trim($('#mulu_detail').val())
        $(this).attr('name',mulu)
        var port=$('#case_sousuo').attr('port')
        $.post('http://127.0.0.1:'+port+'/get_case_detail',{"type":"get_case","mulu":mulu},
        function(data) {
            if (data.type != 'success') {
                $('#case_sousuo').attr('disabled',false)
                layer.msg(data.ceshi,{icon: 2})
            }
            else
            {
                $('#mulu_detail').val('')
                $('#mulu_detail').attr('mulu',mulu)
            var fangfa_head = $('#fangfa_head_hide').html()
            var fangfa_html = $('#fangfa_table').html()
            var class_table = $('#class_table').html()
            $.each(data.ceshi, function (a, b) {
                $('#xiangmu_body').append(class_table)
                var class_ele=$('[tr_type="class"]').eq(-2)
                class_ele.find('[name="class_name"]').html(a)
                class_ele.find('[name="choice"]').attr('id', a)
                class_ele.find('[name="class_doc"]').html(b[0]['class_doc'])
                $('#xiangmu_body').find('tr').eq(-1).attr('class_name', a)
                class_ele.find('[name="class_run"]').attr('cl_name', a)
                class_ele.find('[name="fangfa_list_shwo"]').attr('cl_name', a)
                $('#xiangmu_body').append(fangfa_head)
                $('[table_type="def_head"]').eq(-2).attr('class_name', a)
                $('#xiangmu_body').find('tr').eq(-2).attr('class_name', a)
                for (key in b[1]) {
                    $('#xiangmu_body').append(fangfa_html)
                    $('#xiangmu_body').find('tr').eq(-1).attr('class_name', a)
                    $('[name="def_name"]').eq(-2).html(key)
                    $('[name="def_doc"]').eq(-2).html(b[1][key])
                    $('[name="def_run"]').eq(-2).attr('cl_name', a)
                    $('[name="def_run"]').eq(-2).attr('def_name', key)
                    $('[name="def_choice"]').eq(-2).attr('def_name', key)
                    $('[name="def_choice"]').eq(-2).attr('cl_name', a)
                }
                $('[class_name="' + a + '"]').hide()
                $('[class_name="' + a + '"]').eq(0).show()
                $('[ table_type="def_head"]').hide()
            })
            $('#case_sousuo').attr('disabled', false)
        }
        })
    })

        $('#read_result').click(function()
    {
        window.open('http://127.0.0.1:5025/open_window_page_result?type=run_all', ["结果页面"])
    })
    $('[name="class_simple_result"]').each(function(){
    $(this).click(function(){
    alert(222)
        class_name=$(this).parent().parent().parent().parent().parent().attr('class_name')
        window.open('http://127.0.0.1:5025/open_window_page_result?type=class_all&class_name='+classname, ["结果页面"])
    })
})



$('#xiangmu_body').on('click','[name="class_simple_result"]',function()
{
    class_name=$(this).parent().parent().parent().parent().parent().attr('class_name')
    window.open('http://127.0.0.1:5025/open_window_page_result?type=class_all&class_name='+class_name, ["结果页面"])
})

$('#xiangmu_body').on('click','[name="def_result"]',function()
{
    class_name=$(this).prev().attr('cl_name')
    def_name=$(this).prev().attr('def_name')
    window.open('http://127.0.0.1:5025/open_window_page_result?type=def_run&class_name='+class_name+'&def_name='+def_name, ["结果页面"])
})

    </script>
{% endblock %}