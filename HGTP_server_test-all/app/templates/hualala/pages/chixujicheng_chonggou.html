{% extends "/hualala/pages/base.html" %}
{% block content %}
    <style type="text/css">
        .mt-10 {
            margin-top: 25px;
        }

        .mt-low {
            margin-top: 15px;
        }

        .textarea {
            width: 650px;
            min-height: 220px;
            max-height: 300px;
            _height: 120px;
            margin-left: auto;
            margin-right: auto;
            padding: 3px;
            outline: 0;
            border: 1px solid #a0b3d6;
            font-size: 12px;
            line-height: 24px;
            padding: 2px;
            word-wrap: break-word;
            overflow-x: hidden;
            overflow-y: auto;
            border-color: rgba(82, 168, 236, 0.8);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);
        }

        .row.no-gutter {
            margin-left: 0;
            margin-right: 0;
        }
    </style>
    <div class="container-fluid">
        <div class="row  mt-10 " id="media_tab">
            <div class="col-sm-4">
                <div class="row  mt-10 ">
                    <div class="col-sm-6">
                        <div class="media"><a href="#" class="pull-left"> <img
                                src="static/imageslogin/111.png"
                                class="media-object" style="width:70px"> </a>
                            <div class="media-body" contenteditable="true" disabled="disabled"
                                 style="position: relative; top: 8px; left: -1px; z-index: 2;">
                                <h5 class="media-heading">运行次数</h5>
                                <strong><h4><strong style="position: relative; top: 13px;"
                                                    id="yunxingcishu">300</strong></h4></strong></div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="media"><a href="#" class="pull-left"> <img
                                src="static/imageslogin/222.png"
                                class="media-object" style="width:70px"> </a>
                            <div class="media-body" contenteditable="true" disabled="disabled"
                                 style="position: relative; top: 9px; left: -1px; z-index: 2;">
                                <h5 class="media-heading">通过数</h5>
                                <strong><h4><strong style="position: relative; top: 12px;"
                                                    id="otngguoshu">30000</strong></h4></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row  mt-10 ">
                    <div class="col-sm-6">
                        <div class="media"><a href="#" class="pull-left"> <img
                                src="static/imageslogin/333.png"
                                class="media-object" style="width:70px"> </a>
                            <div class="media-body" contenteditable="true" disabled="disabled"
                                 style="position: relative; top: 9px; left: -1px; z-index: 2;">
                                <h5 class="media-heading">失败数</h5>
                                <strong><h4><strong style="position: relative; top: 12px;" id="shibaishu">30000</strong>
                                </h4></strong>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="media"><a href="#" class="pull-left"> <img
                                src="static/imageslogin/444.png"
                                class="media-object" style="width:70px"> </a>
                            <div class="media-body" contenteditable="true" disabled="disabled"
                                 style="position: relative; top: 9px; left: -1px; z-index: 2;">
                                <h5 class="media-heading">通过率</h5>
                                <strong><h4><strong style="position: relative; top: 12px;" id="tongguolv">80%</strong>
                                </h4></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="row mt-low">
                    <div class="col-xs-12">
                        <div id="user_num"></div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row  mt-10 ">
            <div class="col-sm-3">
                <div class="btn-group btn-group-justified btn-group-sm" role="group" aria-label="...">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-warning" name="simple_detail_git" id="yewu_guanli">
                            业务管理
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#yunxingtime"
                                id="banben_guanli">
                            添加版本
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#yunxingtime"
                                id="daoru_case">
                            导入case
                        </button>
                    </div>
{#                    <div class="btn-group btn-group-sm" role="group">#}
{#                        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#yunxingtime"#}
{#                                id="daochu_case">#}
{#                            导出case#}
{#                        </button>#}
{#                    </div>#}
                </div>
            </div>
        </div>
        <div class="row mt-10">
            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading">项目列表</div>
                    <table class="table table-bordered table-hover" style=”word-break:break-all; word-wrap:break-all;”>
                        <thead>
                        <tr>
                            <th>
                                <input type="checkbox" name="all_choice"></th>
                            <th>业务</th>
                            <th>版本</th>
                            <th>接口数</th>
                            <th>用例数</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="xiangmu_body">
                        {% for i in all_data %}
                            <tr test="true" version_id={{ i[0] }}  bus_id={{ i[2] }}>
                                <td>
                                    <input type="checkbox" name="this_choice">
                                </td>
                                <td>{{ i[8] }}</td>
                                <td>{{ i[1] }}</td>
                                <td>{{ i[11] }}</td>
                                <td>{{ i[10] }}</td>
                                <td>{{ i[4] }}</td>
                                <td>
                                    <div class="btn-group btn-group-xs" role="group">
                                        {#                                        <button class="btn btn-success btn-xs" type="button" name="case_detail"#}
                                        {#                                                data-toggle="modal" data-target="#case_list"#}
                                        {#                                        >运行#}
                                        {#                                        </button>#}
                                        <button class="btn btn-success btn-xs" type="button" name="run_case_this"
                                                data-toggle="modal" data-target="#bianji_alert">详情
                                        </button>
                                        <button class="btn btn-info btn-xs" type="button" name="quanxian_guanli"
                                        >权限管理
                                        </button>
                                        <button class="btn btn-warning btn-xs" type="button" name="bianji_this"
                                                data-toggle="modal" data-target="#bianji_alert">编辑
                                        </button>
                                        <button class="btn btn-danger btn-xs" type="button" name="delete_this"
                                        >删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <div>
                        <ul class="pagination" id="fenye_first">
                            <li><a href="#">&laquo;</a></li>
                            <li><a href="#">&raquo;</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="simple_run_detail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog   modal-sm" style="width:550px;height:200px">
            <div class="modal-content">
                <div class="modal-header" style="height:50px">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h5 class="modal-title"><strong>业务管理</strong></h5>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row ">
                            <div class="col-md-12">
                                <form class="form-horizontal" id="xinzengyewu_all">
                                    <div class="form-group">
                                        <label for="inputPassword" class="col-sm-2 control-label">新增业务</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control input-sm" placeholder="业务名"
                                                   id="yewu_new_add">
                                            <span class="input-group-btn">
        <button class="btn btn-success btn-sm" type="button" id="yewu_add">提交</button>
      </span>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="row ">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <table class="table table-bordered table-hover " id="table_yewu">
                                        <thead>
                                        <tr class="primary">
                                            <th>业务名</th>
                                            <th>添加时间</th>
                                            <th>添加人</th>
                                            <th>关联版本</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="time_all_body_git_simple">
                                        <tr class="success" test="true" style="cursor:pointer">
                                            <td>
                                                孙振
                                            </td>
                                            <td>95%</td>
                                            <td>2分11秒</td>
                                            <td>
                                                否
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group" aria-label="...">
                                                    <button type="button" name="yewu_bianji"
                                                            class="btn btn-xs btn-default">编辑
                                                    </button>
                                                    <button type="button" name="yewu_shanchu"
                                                            class="btn btn-xs btn-default">删除
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning btn-sm" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="banben_guan_li" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog   modal-sm" style="width:400px">
            <div class="modal-content">
                <div class="modal-header" style="height:50px">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h5 class="modal-title"><strong>添加版本</strong></h5>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row ">
                            <div class="col-sm-12">
                                <form class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">选择业务</label>
                                        <div class="col-sm-9" name="file_secret">
                                            <select class="form-control" id="add_yewu_detail_banben">

                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="row mt-low" name="file_top_url">
                            <div class="col-sm-12">
                                <div class="input-group">
                                    <span class="input-group-addon" id="basic-addon3">版本名</span>
                                    <input type="text" class="form-control" id="add_yewu_name"
                                           aria-describedby="basic-addon3">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer mt-10">
                        <button type="button" class="btn btn-success btn-sm" id="banben_add">提交</button>
                        <button type="button" class="btn btn-warning btn-sm" data-dismiss="modal">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>

    <div class="modal fade" id="daochu_case_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog   modal-sm" style="width:400px">
            <div class="modal-content">
                <div class="modal-header" style="height:50px">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h5 class="modal-title"><strong>导出case</strong></h5>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row mt-low">
                            <div class="col-sm-12">
                                <form class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">选择版本</label>
                                        <div class="col-sm-9" name="file_secret">
                                            <select class="form-control" id="daochu_case_version">
                                                {% for i in all_data %}
                                                    <option version_id="{{ i[0] }}">{{ i[1] }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="row mt-low" name="file_top_url">
                            <div class="col-sm-12">
                                <div class="input-group">
                                    <span class="input-group-addon" id="basic-addon3">目录</span>
                                    <input type="text" class="form-control" id="daochucase_mulu"
                                           aria-describedby="basic-addon3">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer mt-10">
                        <button type="button" class="btn btn-success btn-sm" id="daochu_sumbit">提交</button>
                        <button type="button" class="btn btn-warning btn-sm" data-dismiss="modal">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>

    <div class="modal fade" id="daoru_case_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog   modal-sm" style="width:400px">
            <div class="modal-content">
                <div class="modal-header" style="height:50px">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h5 class="modal-title"><strong>导入case</strong></h5>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row mt-low">
                            <div class="col-sm-12">
                                <form class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">选择版本</label>
                                        <div class="col-sm-9" name="file_secret">
                                            <select class="form-control" id="daoru_case_version">
                                                {% for i in all_data %}
                                                    <option version_id="{{ i[0] }}">{{ i[1] }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="row mt-low" name="file_top_url">
                            <div class="col-sm-12">
                                <div class="input-group">
                                    <span class="input-group-addon" id="basic-addon3">目录</span>
                                    <input type="text" class="form-control" id="daorucase_mulu"
                                           aria-describedby="basic-addon3">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer mt-10">
                        <button type="button" class="btn btn-success btn-sm" id="daoru_sumbit">提交</button>
                        <button type="button" class="btn btn-warning btn-sm" data-dismiss="modal">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>


    <div class="modal fade" id="quanxian_guanli" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog   modal-lg" id="quanxianguanli_modal" style="width:800px">
            <div class="modal-content">

                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row mt-low">
                            <div>
                                <!-- Nav tabs -->
                                <ul class="nav nav-tabs" role="tablist">
                                    <li role="presentation" class="active"><a href="#home" aria-controls="home"
                                                                              role="tab" data-toggle="tab">操作权限管理</a>
                                    </li>
                                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab"
                                                               data-toggle="tab">导入权限管理</a></li>
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div role="tabpanel" class="tab-pane active" id="home">
                                        <div class="mt-10">
                                            {% for i in all_user %}
                                                <div class="col-sm-4">
                                                    <form class="form-horizontal">
                                                        <div class="form-group">
                                                            <label class="col-sm-5 control-label"
                                                                   name="quanxian_this_name">{{ i }}</label>
                                                            <div class="col-sm-7">
                                                                <select class="form-control" name="quanxian_detail"
                                                                        user_name="{{ i }}">
                                                                    <option>普通用户</option>
                                                                    <option>开发者</option>
                                                                    <option>管理员</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            {% endfor %}
                                        </div>

                                    </div>
                                    <div role="tabpanel" class="tab-pane" id="profile">
                                        <div>
                                            <div class="mt-low">
                                                <select class="form-control" name="daoru_quanxian_name"
                                                >
                                                    {% for i in all_user %}
                                                        <option user_name={{ i }}>{{ i }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="panel panel-success  mt-low">
                                                <div class="panel-body" id="daoru_mulu_quanxian">



{#                                                #}
{#                                                    {% for i in mulu_all.keys() %}#}
{#                                                     <div class="row">#}
{#                                                    <label for="name">{{ i }}</label>#}
{#                                                     </div>#}
{#                                                    <div class="row">#}
{#                                                    {% for z in mulu_all[i] %}#}
{#                                                        <div class="col-sm-4">#}
{#                                                            <label class="checkbox-inline">#}
{#                                                                <input type="checkbox" catalog_id={{ z[0] }}  name="checbox_mulu"#}
{#                                                                      > {{ z[1] }}#}
{#                                                            </label>#}
{#                                                        </div>#}
{#                                                        {% endfor %}#}
{#                                                    </div>#}
{#                                                    {% endfor %}#}
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="modal-footer mt-10">
                        <button type="button" class="btn btn-warning btn-sm" data-dismiss="modal">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>


    <script src="static/hualala/vendor/jquery/jquery.min.js"></script>
    <script src="static/hualala/vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--<script src="static/bootstrap-table-master/dist/bootstrap-table.min.js"></script>-->
    <script src="static/hualala/vendor/metisMenu/metisMenu.min.js"></script>
    <script src="static/hualala/dist/js/sb-admin-2.js"></script>
    <script src="static/layer-v3.0/layer/layer.js"></script>
    <script src="static/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="static/echarts/echarts.min.js"></script>
    <script src="static/fenye/fenye.js"></script>
    <script src="static/fenye/jiekou_pic.js"></script>
    <script src="static/jquery-cookie-js/jquery.cookie.js"></script>
    <script type=text/javascript>
        var $SCRIPT_ROOT = 'http://' + window.location.host + '/'
        $(document).ready(function () {
            $('[href="#home"]').on('shown.bs.tab', function () {
                $('#quanxianguanli_modal').attr('style', 'width:800px')
            })
            $('[href="#profile"]').on('shown.bs.tab', function () {
                $('#quanxianguanli_modal').attr('style', 'width:450px')
                 url_take = $SCRIPT_ROOT + '/jing/Import_permission'
                var version_id = $(this).parent().parent().parent().attr('version_id')
                var user_name=$('[name="daoru_quanxian_name"]').val()

            })
            $.post($SCRIPT_ROOT + '/jing/read_run_case_detail', {version_id: ''}, function (data) {
                $('#yunxingcishu').html(data.detail['frequency'])
                $('#otngguoshu').html(data.detail['case_pass'])
                $('#shibaishu').html(data.detail['case_fail'])
                $('#tongguolv').html(data.detail['pass_rate'])
            })
            $.removeCookie('import_status', {path: '/'})
            var ht = $('#media_tab').height().toString()
            var b = "width: 100%;height:210px;"
            $('#user_num').attr('style', b)
            zhexianpic(document.getElementById('user_num'), ['2月12日', '2月13日', '2月14日', '2月15日', '2月16日'],
                [7, 3, 4, 12, 4])
        })
        //点击权限管理弹出权限管理对话框
        $('[name="quanxian_guanli"]').click(function () {
            var version_id = $(this).parent().parent().parent().attr('version_id')
            $.post($SCRIPT_ROOT + 'tree/get_quanxian', {version_id: version_id}, function (data) {
                if (data.statu_this == 0 || data.statu_this == 1) {
                    layer.msg('权限不足', {
                        shade: [0.3, '#fff'],
                        shadeClose: true,
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    })
                } else {
                    $('#quanxian_guanli').modal('show')
                    $.each(data.all_quanxian, function (k, i) {

                    })
                    var  label_detail='                           <div name="all_mulu_file">\n' +
                        '                                                     <div class="row">\n' +
                        '                                                    <label for="name"></label>\n' +
                        '                                                     </div>\n' +
                        '                                                    <div class="row" name="this_roww">\n' +
                        '                                                     \n' +
                        '                                                       \n' +
                        '                                                    </div>\n' +
                        '                                                    </div>'

                    var this_mulu='                <div class="col-sm-4">\n' +
                        '                                                            <label class="checkbox-inline">\n' +
                        '                                                               \n' +
                        '                                                            </label>\n' +
                        '                                                        </div>'
                    var next_mulu_de='<input type="checkbox" catalog_id="222"  name="checbox_mulu"\n' +
                        '                                                                      > '
                    $.each(data.all_mulu,function(a,b)
                    {

                       console.log(a,b)
                       $('#daoru_mulu_quanxian').append(label_detail)
                        $('#daoru_mulu_quanxian').find('label').eq(-1).html(a)
                        $.each(b,function(z,k){
                             $('#daoru_mulu_quanxian').find('label').eq(-1)
                                         $('[name="this_roww"]').eq(-1).append(
                              this_mulu
                           )
                            console.log(k)
                           $('.checkbox-inline').eq(-1).append(next_mulu_de+k[0])
                             $('.checkbox-inline').eq(-1).find('input').attr('catalog_id',k[1])

                        })

                    })

                    $('[name="quanxian_this_name"]').each(function (u, z) {
                        var this_name = $(this).html()
                        var this_el = $(this)
                        var statu = 0
                        $.each(data.all_quanxian, function (k, i) {
                            if ($.trim(k) == this_name) {
                                var statu = 1
                                if (parseInt(i) == 0) {
                                    this_el.next().find('select').val('普通用户')
                                } else if (parseInt(i) == 1) {
                                    this_el.next().find('select').val('开发者')
                                } else if (parseInt(i) == 2) {
                                    this_el.next().find('select').val('管理员')
                                }
                            }

                        })
                        if (statu == 1) {
                            this_el.next().find('select').val('普通用户')
                        }


                    })

                    {#$('[name="quanxian_this_name"]').each(function)#}
                }
            })


        })

        //修改权限
        $('[name="quanxian_detail"]').change(function () {
            var user_name = $(this).parent().prev().html()
            var statu_name = $(this).val()
            var statu = 0
            if (statu_name == '普通用户') {
                statu = 0
            } else if (statu_name == "开发者") {
                statu = 1
            } else if (statu_name == "管理员") {
                statu = 2
            }
            $.post($SCRIPT_ROOT + 'common/user_jurisdiction', {user: user_name, statu: statu}, function (data) {
                var return_data = JSON.parse(data)
                if (return_data.statu == "success") {
                    layer.msg('更新成功', {
                        shade: [0.3, '#fff'],
                        shadeClose: true,
                        icon: 1,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    })
                } else {
                    layer.msg(return_data.detail, {
                        shade: [0.3, '#fff'],
                        shadeClose: true,
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    })
                }
            })


        })

        //操作单选按钮是否选择
        function all_choice(ele_all, ele_this) {
            ele_all.click(function () {
                if ($(this).is(':checked')) {
                    ele_this.attr('checked', true)
                } else {
                    ele_this.attr('checked', false)
                }
            })

        }

        all_choice($('[name="all_choice"]'), $('[name="this_choice"]'))

        function getLocalTime(nS) {
            return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/, ' ');
        }

        var add_table = '                                        <tr class="success"   test="true" style="cursor:pointer">\n' +
            '                                            <td>\n' +
            '                                                孙振\n' +
            '                                            </td>\n' +
            '                                            <td>95%</td>\n' +
            '                                            <td>2分11秒</td>\n' +
            '                                            <td>\n' +
            '                                               否\n' +
            '                                            </td>\n' +
            '                                            <td>\n' +
            '                                                <div class="btn-group" role="group" aria-label="...">\n' +
            '                                                    <button type="button"  name="yewu_bianji"   class="btn btn-xs btn-default">编辑</button>\n' +
            '                                                    <button type="button"  name="yewu_shanchu"  class="btn btn-xs btn-default">删除</button>\n' +
            '                                                </div>\n' +
            '                                            </td>\n' +
            '                                        </tr>'
        $('[name="simple_detail_git"]').click(function () {
            $('#simple_run_detail').modal('show')
            $('#yewu_new_add').val('')
        })

        $('#simple_run_detail').on('show.bs.modal', function () {
            $('#time_all_body_git_simple').empty()
            $.ajax({
                type: "post",
                url: $SCRIPT_ROOT + 'jing/common/get_bus',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({"type": 0}),
                success: function (data) {
                    $.each(data, function (a, b) {
                        $.each(b, function (k, i) {
                            $('#time_all_body_git_simple').append(add_table)
                            var all_ta = $('#time_all_body_git_simple').find('tr').eq(-1).find('td')
                            $('#time_all_body_git_simple').find('tr').eq(-1).attr('data_id', i[0])
                            all_ta.eq(0).text(i[1])
                            all_ta.eq(1).text(getLocalTime(i[3]))
                            all_ta.eq(2).text(i[2])

                        })
                    })
                }
            })
        })

        $('#banben_guan_li').on('show.bs.modal', function () {
            $('#add_yewu_detail_banben').empty()
            $('#add_yewu_name').val('')
            $.ajax({
                type: "post",
                url: $SCRIPT_ROOT + 'jing/common/get_bus',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({"type": 0, "bus_id": 0}),
                success: function (data) {
                    var z_data = '<option>iot</option>'
                    $.each(data, function (a, b) {
                        $.each(b, function (k, i) {
                            $('#add_yewu_detail_banben').append(z_data)
                            $('#add_yewu_detail_banben').find('option').eq(-1).attr('yewu_id', i[0])
                            $('#add_yewu_detail_banben').find('option').eq(-1).text(i[1])
                        })
                    })
                }
            })
        })

        $('#banben_guanli').click(function () {
            $('#banben_guan_li').modal('show')
        })
        //编辑按钮点击

        $('#time_all_body_git_simple').on('click', '[name="yewu_bianji"]', function () {
            if ($(this).text() == "编辑") {
                var this_el = $(this).parent().parent().parent().find('td').eq(0)
                var html_data = "<input type=\"text\" class=\"form-control input-sm\" name=\"input_yewu\" placeholder=\"业务名\" style=\"width:70px;height:20px\">\n"
                var this_data = $.trim(this_el.html())
                $(this).text('更新')
                this_el.html('')
                this_el.append(html_data)
                this_el.find('input').attr('placeholder', this_data)

            } else if ($(this).text() == "更新") {
                var this_data = $(this).parent().parent().parent().find('td').eq(0).find('[name="input_yewu"]').val()
                $(this).parent().parent().parent().find('td').eq(0).html(this_data)
                var id_data = $(this).parent().parent().parent().attr('data_id')
                $.ajax({
                    type: "post",
                    url: $SCRIPT_ROOT + 'jing/common/update_bus',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({"bus_name": this_data, 'id': id_data}),
                    success: function (data) {
                        if (data.statu == 'success') {
                            layer.msg('更新成功', {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                            $('#simple_run_detail').modal('hide')
                        } else {

                            if (data.detail == noe) {
                                error_detail = "未知错误"
                            } else {
                                error_detail = data.detail
                            }
                            layer.msg(error_detail, {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                            $('#simple_run_detail').modal('hide')
                        }

                    }
                })
            }
        })

        $('#yewu_add').click(function () {

            var yewu_new_add = $('#yewu_new_add').val()
            if ($.trim(yewu_new_add) == '') {
                layer.msg('业务名不能为空', {
                    shade: [0.3, '#fff'],
                    shadeClose: true,
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                })
            } else {

                $.ajax({
                    type: "post",
                    url: $SCRIPT_ROOT + 'jing/add_bus',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({"bus_name": yewu_new_add}),
                    success: function (data) {
                        if (data.status == 'success') {
                            layer.msg('添加成功', {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                            $('#simple_run_detail').modal('hide')
                        } else {
                            layer.msg(data.detail, {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 2,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                            $('#simple_run_detail').modal('hide')
                        }
                    }
                })
            }
        })
        //delete  yewu
        $('#time_all_body_git_simple').on('click', '[name="yewu_shanchu"]', function () {
            var id_data = $(this).parent().parent().parent().attr('data_id')
            $.ajax({
                type: "post",
                url: $SCRIPT_ROOT + 'jing/common/delete_bus',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({"id": id_data}),
                success: function (data) {
                    if (data.status == 'success') {
                        layer.msg('删除成功', {
                            shade: [0.3, '#fff'],
                            shadeClose: true,
                            icon: 1,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        })
                        $('#simple_run_detail').modal('hide')
                    } else {
                        layer.msg(data.detail, {
                            shade: [0.3, '#fff'],
                            shadeClose: true,
                            icon: 2,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        })
                        $('#simple_run_detail').modal('hide')
                    }
                }
            })
        })
        $('#banben_add').click(function () {
            var yewu_name = $('#add_yewu_detail_banben').val()
            var banben_name = $('#add_yewu_name').val()
            var yewu_id = ''
            $('#add_yewu_detail_banben').find('option').each(function () {
                if ($(this).val() == yewu_name) {

                    yewu_id = $(this).attr('yewu_id')
                }

            })
            if ($.trim(banben_name) == '') {
                layer.msg("版本号不能为空", {
                    shade: [0.3, '#fff'],
                    shadeClose: true,
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                })
                $('#banben_guan_li').modal('hide')
            } else {
                $.ajax({
                    type: "post",
                    url: $SCRIPT_ROOT + '/common/new_version',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({"bus_id": yewu_id, "version_name": banben_name}),
                    success: function (data) {
                        if (data.statu == 'success') {
                            layer.msg('添加成功', {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                            $('#banben_guan_li').modal('hide')
                            setTimeout("window.location.reload()", 1000)
                        } else {
                            layer.msg(data.detail, {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 2,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })

                        }
                    }
                })

            }
        })
        $('[name="bianji_this"]').click(function () {
            if ($.trim($(this).text()) == '编辑') {
                var html_data = "<input type=\"text\" class=\"form-control input-sm\" name=\"banben_input\" placeholder=\"业务名\" style=\"width:100px;height:23px\">\n"
                var this_name = $(this).parent().parent().parent().find('td').eq(1).text()
                $(this).parent().parent().parent().find('td').eq(1).text('')
                $(this).parent().parent().parent().find('td').eq(1).append(html_data)
                $('[name="banben_input"]').attr('placeholder', this_name)
                $(this).text('更新')
            } else {
                var version_name = $('[name="banben_input"]').val()
                var version_id = $(this).parent().parent().parent().attr('version_id')
                $.post($SCRIPT_ROOT + '/tree/update_version', {
                    version_id: version_id,
                    version_name: version_name
                }, function (data) {
                    if (data.statu == 'success') {
                        layer.msg('更新成功', {
                            shade: [0.3, '#fff'],
                            shadeClose: true,
                            icon: 1,
                            time: 1000 //2秒关闭（如果不配置，默认是3秒）
                        })
                        setTimeout("window.location.reload()", 1000)
                    } else {
                        layer.msg(data.detail, {
                            shade: [0.3, '#fff'],
                            shadeClose: true,
                            icon: 2,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        })
                    }
                })
                $(this).text('编辑')
            }
        })

        $('[name="delete_this"]').click(function () {
            var version_id = $(this).parent().parent().parent().attr('version_id')
            layer.confirm('是否确定要删除', {
                btn: ['是', '否'] //按钮
            }, function () {
                delete_version(version_id);
            }, function () {

            })

            function delete_version(version_id) {
                $.ajax({
                    type: "post",
                    url: $SCRIPT_ROOT + '/tree/delete_version',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({"id": version_id}),
                    success: function (data) {
                        if (data.statu == 'success') {
                            layer.msg('删除成功', {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                            setTimeout("window.location.reload()", 1000)
                        } else {
                            layer.msg(data.detail, {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 2,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })

                        }
                    }
                })
            }
        })
        $('#daoru_case').click(function () {

            $('#daoru_case_modal').modal('show')
        })


        $('#daochu_case').click(function () {

            $('#daochu_case_modal').modal('show')
        })
        $('#daoru_sumbit').click(function () {
            //判断本地server有没有启动起
            $.ajax({
                type: "POST",
                url: 'http://127.0.0.1' + ':5083' + '/banben_data',
                data: "",
                error: function (data, type, err) {
                    layer.alert('请启动本地server ', {icon: 2})
                },
                success: function (msg) {

                }
            })

            $.ajaxSetup({
                async: false
            })
            var banebn_name = $('#daoru_case_version').val()
            var version_id = ''
            $('#daoru_case_version').find('option').each(function (k, i) {
                if ($.trim($(this).text()) == banebn_name) {
                    version_id = $(this).attr('version_id')
                }
            })
            var mulu = $('#daorucase_mulu').val()
            daoru_all(version_id, mulu)
            {#layer.closeAll()#}
        })

        //导入配置文件所有接口
        function daoru_all(version_id, mulu) {
            var version_id = version_id
            var mulu = mulu
            //获取目录结构
            var statu = ''
            $.post($SCRIPT_ROOT + '/conn/import_status', {status: 0, mulu: mulu}, function (data) {
                if (data.status == 'success') {

                    statu = "success"

                } else {
                    layer.msg(data.error_detail, {
                        shade: [0.3, '#fff'],
                        shadeClose: true,
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    })
                }

            })
            if (statu == "success") {
                $.ajax({
                    type: "post",
                    url: 'http://127.0.0.1:5083/haiou/restructure/get_catalog/',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({"id": parseInt(version_id), "mulu": mulu}),
                    success: function (data) {
                        if (data.statu == 'success') {
                            {#layer.msg('导入成功', {#}
                            {#    shade: [0.3, '#fff'],#}
                            {#    shadeClose: true,#}
                            {#    icon: 1,#}
                            {#    time: 2000 //2秒关闭（如果不配置，默认是3秒）#}
                            $.post($SCRIPT_ROOT + '/haiou/save_catalog', {
                                "catalog_detail": JSON.stringify(data),
                                "id": parseInt(version_id)
                            }, function (data) {
                                if (data.status != "success") {
                                    statu = ''
                                    charge_run_detial(data)
                                } else {
                                    statu = "success"
                                }

                            })

                        } else {
                            layer.msg(data.detail, {
                                shade: [0.3, '#fff'],
                                shadeClose: true,
                                icon: 2,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            })
                        }
                    }
                })
            }
            //获取接口列表
            if (statu == "success") {
                statu = ''
                $.post('http://127.0.0.1:5083/common/Interface_list', {
                    "id": parseInt(version_id),
                    "mulu": mulu
                }, function (data) {
                    var re_data = JSON.parse(data)
                    if (re_data.statu == 'success') {
                        statu = 'success'
                        $.post($SCRIPT_ROOT + '/common/save_interface', {
                            interface_detail: re_data.inerface_list,
                            id: parseInt(version_id)
                        }, function (data) {

                        })

                    } else {

                    }
                })
            }
            //获取公共配置文件
            if (statu == "success") {
                statu = ''
                $.post('http://127.0.0.1:5083/jing/publick_config', {
                    "id": parseInt(version_id),
                    "mulu": mulu
                }, function (data) {
                    var publick_detail = JSON.stringify(data.interface_list)
                    if (data.statu == 'success') {
                        statu = 'success'
                        $.post($SCRIPT_ROOT + '/jing/save_publick_config', {
                            publick_config_detail: JSON.stringify(data.interface_list),
                            id: parseInt(version_id)
                        }, function (data) {

                        })
                    } else {

                    }
                })
            }
            if (statu == "success") {
                statu = ''
                $.post('http://127.0.0.1:5083/new/privae_config', {
                    "id": parseInt(version_id),
                    "mulu": mulu
                }, function (data) {
                    var private_config = JSON.stringify(data.private_config)
                    if (data.statu == 'success') {
                        statu = 'success'
                        $.post($SCRIPT_ROOT + '/jing/save_private_config', {
                            private_config: private_config,
                            version_id: parseInt(version_id)
                        }, function (data) {

                        })
                    } else {

                    }
                })
            }
            if (statu == "success") {
                statu = ''
                $.post('http://127.0.0.1:5083/new/read_case', {
                    "version_id": parseInt(version_id),
                    "mulu": mulu
                }, function (data) {
                    var private_config = JSON.stringify(data.private_config)
                    if (data.statu == 'success') {
                        statu = 'success'
                        $.post($SCRIPT_ROOT + '/jing/save_case', {
                            case_detail: JSON.stringify(data.case_detail),
                            version_id: parseInt(version_id)
                        }, function (data) {
                            if (data.statu == 'success') {
                                $('#daoru_case_modal').modal('hide')
                                layer.msg('导入成功', {
                                    shade: [0.3, '#fff'],
                                    shadeClose: true,
                                    icon: 1,
                                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                                })
                            } else {

                                $('#daoru_case_modal').modal('hide')
                                layer.msg(data.detail, {
                                    shade: [0.3, '#fff'],
                                    shadeClose: true,
                                    icon: 2,
                                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                                })

                            }
                        })
                    } else {

                    }
                })
            }
            $.post($SCRIPT_ROOT + '/conn/import_status', {status: 1, mulu: mulu}, function (data) {
                if (data.status == 'success') {

                    statu = "success"

                } else {
                    layer.msg(data.error_detail, {
                        shade: [0.3, '#fff'],
                        shadeClose: true,
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    })
                }

            })
        }

        $('[name="run_case_this"]').click(function () {
            var version_id = $(this).parent().parent().parent().attr('version_id')
            $.post($SCRIPT_ROOT + 'inter_face_detail', {version_id: version_id}, function () {
                window.location.href = $SCRIPT_ROOT + 'inter_face_detail'

            })
        })

        //判断是否返回成功，否则返回错误ixnxi
        function charge_run_detial(data) {
            if (data.statu != 'success') {
                layer.msg(data.detail, {
                    shade: [0.3, '#fff'],
                    shadeClose: true,
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                })

            }
        }


        $('#daochu_sumbit').click(function () {
            var banebn_name = $('#daochu_case_version').val()
            var version_id = ''
            url = 'http://127.0.0.1' + ':5083' + '/saveFile/create_version_case'
            url_take = $SCRIPT_ROOT + '/jing/get_version_case'
            $('#daochu_case_version').find('option').each(function () {
                if ($(this).html() == banebn_name) {
                    version_id = $(this).attr('version_id')
                }
            })
            var catalog = $('#daochucase_mulu').val()
            $.post(url, {version_id: version_id, catalog: catalog, url: url_take}, function (data) {
                if (data == 'success') {
                    $('#daochu_case_modal').modal('hide')
                    layer.msg("导出成功", {
                        shade: [0.3, '#fff'],
                        shadeClose: true,
                        icon: 1,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    })
                }
            })

        })

    $('[name="daoru_quanxian_name"]').change(function(){
        var user_name=$(this).val()
           var version_id = $(this).parent().parent().parent().attr('version_id')
        url_take = $SCRIPT_ROOT + '/jing/Import_permission'
        var interface_id=[]
        $('[name="checbox_mulu"]').each(function(){
            if ($(this).is(':checked'))
            {
                interface_id.push($(this).attr('catalog_id'))
            }
        })
        $.post(url_take,{version_id:version_id,user:user_name,catalog_list:interface_id},function(data){

        })
    })
    </script>
{% endblock %}